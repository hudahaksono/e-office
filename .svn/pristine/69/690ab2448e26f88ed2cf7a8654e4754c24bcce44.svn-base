@model Surat.Models.Entities.BukuPenomran
@{
    var log = HttpContext.Current.User.Identity as Surat.Models.Entities.InternalUserIdentity;
    var lstMonth = new List<SelectListItem>(){
        new SelectListItem { Text = "Januari", Value = "1"},
        new SelectListItem { Text = "Februari", Value = "2"},
        new SelectListItem { Text = "Maret", Value = "3"},
        new SelectListItem { Text = "April", Value = "4"},
        new SelectListItem { Text = "Mei", Value = "5"},
        new SelectListItem { Text = "Juni", Value = "6"},
        new SelectListItem { Text = "Juli", Value = "7"},
        new SelectListItem { Text = "Agustus", Value = "8"},
        new SelectListItem { Text = "September", Value = "9"},
        new SelectListItem { Text = "Oktober", Value = "10"},
        new SelectListItem { Text = "November", Value = "11"},
        new SelectListItem { Text = "Desember", Value = "12"}
    };
}

<style>
    .seriesControl {
        border-radius: 5px;
        padding: 5px 10px;
        padding-bottom: 10px;
        position: relative;
        overflow: hidden;
    }

    .seriesControl select{
        border-radius:4px;
        border: 1px solid #aaa;
    }

    #MainTable {
        position: relative;
    }

        #MainTable thead {
            position: sticky;
            top: 0px;
            background-color: rgb(71, 70, 70);
            color: white;
        }

        #MainTable tr td, #MainTable tr th {
            text-align: center;
        }

        #MainTable tbody tr td:nth-child(3), #MainTable tbody tr td:nth-child(2) {
            text-align: left;
        }

        #MainTable tbody tr input, #MainTable tbody tr textarea {
            width: 100%;
            height: 100%;
        }

    @@media only screen and (max-width: 575px) {
        .conditional {
            margin-top: 10px;
        }
    }

    .lds-ring {
        display: inline-block;
        position: relative;
        width: 80px;
        height: 80px;
    }
        .innertabelring{
            display: block !important;
            width: 0 !important;
            height: 0 !important;
            padding: 0 30%;
        }
        .innertabelring div{
            width: 1.4em !important;
            height: 1.4em !important;
            margin:0 !important;
            border: 4px solid #1973A8;
            border-color: #1973A8 transparent transparent transparent;
        }

        .pagering div{
            border: 8px solid #333333;
            border-color: #333333 transparent transparent transparent;
        }

        .lds-ring div {
            box-sizing: border-box;
            display: block;
            position: absolute;
            width: 64px;
            height: 64px;
            margin: 8px;
            border-radius: 50%;
            animation: lds-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;            
        }

            .lds-ring div:nth-child(1) {
                animation-delay: -0.45s;
            }

            .lds-ring div:nth-child(2) {
                animation-delay: -0.3s;
            }

            .lds-ring div:nth-child(3) {
                animation-delay: -0.15s;
            }

    @@keyframes lds-ring {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .loadingDiv {
        position: relative;
        width: 100%;
        top: 20%;
        left: 40%;
    }
    .tabledetail tr td {
        padding: 2px;
        vertical-align:text-top;
    }

    .nomorTTE {
        position:absolute;
        display:inline-block;
        border-bottom:2px solid blue;
        margin-top:-6px;
    }
    .coursorPointer{
        cursor:pointer;
    }
    .sipNum{
        cursor:pointer;
        position:relative;
    }
    .sipNum .popupRow {
        position: absolute;
        left: 80%;
        top:5px;
        background-color:rgb(71, 70, 70);
        color:white;
        width:200%;
        padding:5px;
        z-index:9;
        text-align:left;
        border: 1px solid #ddd;
        border-top-right-radius: 20px;
        border-bottom-right-radius: 20px;
        text-align:right;
        padding-right:15px;
    }
    .sipNum .popupRow:hover{
        background-color: #337ab7;
    }
</style>


<div style="min-height:90vh">
    <div class="seriesControl bgthird text-light mb-2">
        <div class="row">
            <div class="col-md-6 col-sm-12 col-xs-12">
                <div class="form-group">
                    <label for="">Jenis Naskah Dinas</label>
                    <select class="select2_single form-control formfull" id="slctJenisNaskah" onchange="maintablereload()">
                        @if (ViewBag.JenisNaskahDinas.Count > 0)
                        {
                            foreach (var jenis in ViewBag.JenisNaskahDinas)
                            {
                                if (jenis.NamaTipeSurat == "Nota Dinas")
                                {
                                    <option selected value="@jenis.NamaTipeSurat">@jenis.NamaTipeSurat</option>
                                }
                                else
                                {
                                    <option value="@jenis.NamaTipeSurat">@jenis.NamaTipeSurat</option>
                                }
                            }
                        }
                    </select>
                </div>
            </div>
            <div class="col-md-2 col-sm-12 col-xs-12">
                <div class="form-group">
                    <label for="">Status Arsip</label>
                    <select class="form-control" id="slctStatArsip" onchange="maintablereload()">
                        <option value="">Lihat Semua...</option>
                        <option value="0">Arsip Belum</option>
                        <option value="1">Arsip Sudah</option>
                        <option value="TTE">TTE</option>
                    </select>
                </div>
            </div>
            <div class="col-md-2 col-sm-12 col-xs-12">
                <div class="form-group">
                    <label for="">Bulan</label>
                    @Html.DropDownList("slctBulan", lstMonth, "Lihat Semua...", new { @class = "select2_single form-control input-md", @id = "slctBulan", @onchange = "maintablereload()" })
                </div>
            </div>
            <div class="col-md-2 col-sm-12 col-xs-12">
                <div class="form-group">
                    <label for="">Tahun</label>
                    <select class="form-control" id="slctTahun" onchange="maintablereload()">
                        @if (ViewBag.ListTahun.Count > 0)
                        {
                            foreach (var tahun in ViewBag.ListTahun)
                            {
                                if (tahun == DateTime.Now.Year.ToString())
                                {
                                    <option selected value="@tahun">@tahun</option>
                                }
                                else
                                {
                                    <option value="@tahun">@tahun</option>
                                }
                            }
                        }
                    </select>
                </div>
            </div>
        </div>
        <div class="row" style="margin-top:10px;">
            <div class="col-md-10 col-sm-10 col-xs-10">
                <form id="srchForm">
                    <div class="input-group">
                        @Html.TextBox("srchBox", "", new { @class = "form-control", @id = "srchBox", @placeholder = "Pencarian..." })
                        <span class="input-group-btn">
                            <button id="srchButton" class="btn btn-default" type="button" onclick="maintablereload()"><i class="fa fa-search"></i></button>
                        </span>
                    </div>
                </form>
            </div>
            <div class="col-md-2 col-sm-2 col-xs-2 conditional" style="margin-top:0">
                <button class="btn btn-primary btn-block btnadd" type="button" data-toggle="modal" data-target=".addData">
                    <i class="fa fa-plus-square"></i>
                    Tambah Data
                </button>
            </div>
        </div>
    </div>

    <div class="dataContain conditional" style="background-color:white;padding:10px 0;min-height:500px">
        <table id="MainTable" class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th width="5%">Nomor</th>
                    <th width="20%">Nomor Surat</th>
                    <th width="50%">Perihal</th>
                    <th width="10%">Tanggal Surat</th>
                    <th width="5%">Arsip</th>
                    <th width="10%">Aksi</th>
                </tr>
            </thead>
        </table>
    </div>
</div>


<div class="modal fade addData" tabindex="-1" role="dialog" aria-labelledby="penomoranAddData" aria-hidden="true">
    <div class="modal-dialog pt-3" style="width:70vw;">
        <div class="modal-content" style="position:relative">
            <div class="modal-header">
                <h5 class="modal-title" id="modaltitle">Tambah Data</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="position:absolute;top:10px;right:10px;">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body position: relative;">
                <div class="formInputSection">
                    <form id="formAddData" data-bukunomorid="@Model.BukuNomorId">
                        <div class="nomorInput" style="display:none;">
                            <div class="form-group">
                                <label class="control-label" for="UpdateNomorSurat">Nomor Surat :</label>
                                <input class="form-control" type="text" id="UpdateNomorSurat" value="" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-4 col-md-4">
                                <div class="form-group">
                                    <label class="control-label" for="inputJenisNaskah">Jenis Naskah :</label>
                                    <select name="JenisNaskahDinas" class="testselect form-control formfull wInput" id="inputJenisNaskah">
                                        @if (ViewBag.JenisNaskahDinas.Count > 0)
                                        {
                                            foreach (var jenis in ViewBag.JenisNaskahDinas)
                                            {
                                                <option value="@jenis.NamaTipeSurat">@jenis.NamaTipeSurat</option>
                                            }
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-4">
                                <div class="form-group">
                                    <label class="control-label" for="inputTanggalSurat">Tanggal Surat :</label>
                                    <div class='input-group date timepicker'>
                                        <input name="TanggalSurat" type="text" class="form-control wInput" id='inputTanggalSurat' value="@ViewBag.CurrentDate" />
                                        <span class="input-group-addon">
                                            <span class="glyphicon glyphicon-calendar"></span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-4">
                                <div class="form-group">
                                    <label class="control-label" for="inputProfilePenandatangan">Penandatangan :</label>
                                    <select name="ProfilePenandatangan" class="testselect form-control formfull wInput" id="inputProfilePenandatangan">
                                        @if (Model.ListPenandatanganBuku.Count > 0)
                                        {
                                            foreach (var jbt in Model.ListPenandatanganBuku)
                                            {
                                                <option value="@jbt.ProfileId">@jbt.JabatanNama</option>
                                            }
                                        }
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-6 col-md-6">
                                <div class="form-group">
                                    <label class="control-label" for="inputPerihal">Perihal :</label>
                                    <textarea name="Perihal" class="form-control wInput" id="inputPerihal" placeholder="Masukan Perihal Surat...."></textarea>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-6">
                                <div class="form-group">
                                    <label class="control-label" for="inputKlasArsip">Klasifikasi Arsip :</label>
                                    <div class='input-group'>
                                        <input name="KlasifikasiArsip" type="text" class="form-control wInput" id='inputKlasArsip' value="" placeholder="Masukan Kode Klasifikasi Arsip....." />
                                        <span class="input-group-addon" style="cursor:pointer" onclick="showArsipList()" title="cari kode klasifikasi">
                                            <span class="fa fa-info"></span>
                                        </span>
                                    </div>
                                    <div class="checkbox">
                                        <label>
                                            <input type="checkbox" id="StatusArsip" name="Status"> Status Arsip
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="arsipList" style="display:none">
                    <button class="btn btn-info" onclick="showArsipList()"><i class="fa fa-arrow-left"></i> Kembali</button>
                    <form id="srcharsip">
                        <div class="input-group pull-right">
                            @Html.TextBox("inputsrcharsip", "", new { @class = "form-control", @id = "inputsrcharsip", @placeholder = "Pencarian..." })
                            <span class="input-group-btn">
                                <button id="srchArsipButton" class="btn btn-default" type="button"><i class="fa fa-search"></i></button>
                            </span>
                        </div>
                    </form>
                    <table id="arsipTable" class="table table-striped table-bordered" style="width:100%">
                        <thead>
                            <tr>
                                <th>Kode Kalsifikasi</th>
                                <th>Fungsi</th>
                                <th>Keterangan</th>
                                <th>Pilih</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="detailsurat" style="border-top: 1px solid #e5e5e5;padding:15px;box-sizing:border-box">
                <h5 class="modal-title" style="margin-bottom:20px">Detail Surat </h5>
                <form id="detailSurat">
                    <div class="formdetail" data-details="Surat Tugas" style="display:none">
                        <div class="row">
                            <div class="col-lg-4 col-md-4">
                                <div class="form-group">
                                    <label class="control-label" for="inputTanggalTugas">Waktu tugas :</label>
                                    <div class='input-group date timepicker'>
                                        <input type="text" name="tanggaltugas" class="form-control dInput" id='inputTanggalTugas' value="@ViewBag.CurrentDate" />
                                        <span class="input-group-addon">
                                            <span class="glyphicon glyphicon-calendar"></span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-4">
                                <div class="form-group">
                                    <label class="control-label" for="tujuantugas">Tujuan :</label>
                                    <input class="form-control dInput" type="text" name="tujuantugas" id="tujuantugas" value="" placeholder="masukkan tujuan tugas" />
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-4">
                                <div class="form-group">
                                    <label class="control-label" for="inputPetugas">Yang Ditugaskan :</label>
                                    <textarea class="form-control dInput" id="inputPetugas" name="petugas" placeholder="Masukan Pegawai yang ditugaskan...."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="formdetail" data-details="Surat Undangan" style="display:none">
                        <div class="row">
                            <div class="col-lg-4 col-md-4">
                                <div class="form-group">
                                    <label class="control-label" for="inputTanggalUndangan">Tanggal Undangan :</label>
                                    <div class='input-group date timepicker'>
                                        <input type="text" class="form-control dInput" name="tanggalundangan" id='inputTanggalUndangan' value="@ViewBag.CurrentDate" />
                                        <span class="input-group-addon">
                                            <span class="glyphicon glyphicon-calendar"></span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-2">
                                <div class="form-group">
                                    <label class="control-label" for="lamaundangan">Lama Undangan (Hari) :</label>
                                    <input class="form-control dInput" type="text" name="lamaundangan" id="lamaundangan" value="1" placeholder="masukkan angka" />
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-6">
                                <div class="form-group">
                                    <label class="control-label" for="tujuanUndangan">Kepada :</label>
                                    <textarea class="form-control dInput" name="tujuanundangan" id="tujuanUndangan" placeholder="Masukan Tujuan Undangan...."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="formdetail" data-details="Surat Dinas" style="display:none">
                        <div class="row">
                            <div class="col-lg-12 col-md-12">
                                <div class="form-group">
                                    <label class="control-label" for="tujuanSuratDinas">Kepada :</label>
                                    <textarea class="form-control dInput" name="tujuansuratdinas" id="tujuanSuratDinas" placeholder="Masukan Tujuan Surat...."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-info pull-left" id="btnBook" onclick="bookingNomor()">Booking Nomor</button>
                <button type="button" class="btn btn-primary" onclick="simpanDataPenomoran()">Simpan</button>
            </div>
        </div>
    </div>
</div>

<div id='myModalDocViewer' class='modal'>
    <div class="modal-dialog">
        <div class="modal-content">
            <div id='myModalContent'></div>
        </div>
    </div>
</div>

@*<div class="modal fade dateModal" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" data-keyboard="false" data-backdrop="static">
    <div class="modal-dialog modal-sm" role="document" style="margin:20vh auto">
        <div class="modal-content" style="padding:10px">
            <div class="infoModal" style="text-align:center">
                <h3>Konfirmasi</h3>
                <p class="textmodal" style="font-size:1.2em">Masukan Tanggal Surat</p>
            </div>
            <div class="form-group">
                <label class="control-label" for="inputTanggalSurat">Tanggal Surat :</label>
                <div class='input-group date timepicker'>
                    <input name="modalDatePicker" type="text" class="form-control" id='modalDatePicker' value="@ViewBag.CurrentDate" />
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-calendar"></span>
                    </span>
                </div>
            </div>   
            <div class="row" style="margin-top:20px">
                <div class="col-md-6 col-sm-12">
                    <button class="btn btn-warning btn-block dateCancel" type="button" data-dismiss="modal" aria-label="Close">
                        Batal
                    </button>
                </div>
                <div class="col-md-6 col-sm-12">
                    <button class="btn btn-primary btn-block dateAcc" type="button">
                        Simpan
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>*@

<div class="modal fade modalinfo" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title"> Modal title</h4>
            </div>
            <div class="modal-body">
                <div>
                    <table class="tabledetail" cellspacing="0" cellpadding="0" style="border:none;width:100%">
                        <tr>
                            <td style="width:20%">Penandatangan</td>
                            <td style="width:5%">:</td>
                            <td style="width:75%"><span class="detailTable" data-detail="penandatangan">asdsadsad</span></td>
                        </tr>
                        <tr>
                            <td>PIC</td>
                            <td>:</td>
                            <td><span class="detailTable" data-detail="UserInput">asdsadsad</span></td>
                        </tr>
                        <tr>
                            <td>Satker yang Mengajukan</td>
                            <td>:</td>
                            <td><span class="detailTable" data-detail="satkerInput">asdsadsad</span></td>
                        </tr>
                        <tr>
                            <td>Klasifikasi Arsip</td>
                            <td>:</td>
                            <td><span class="detailTable" data-detail="klasArsip">asdsadsad</span></td>
                        </tr>
                        <tr>
                            <td>Tanggal Tugas</td>
                            <td>:</td>
                            <td><span class="detailTable" data-detail="tanggaltugas">asdsadsad</span></td>
                        </tr>
                        <tr>
                            <td>Tujuan Tugas</td>
                            <td>:</td>
                            <td><span class="detailTable" data-detail="tujuantugas">asdsadsad</span></td>
                        </tr>
                        <tr>
                            <td>yang ditugaskan</td>
                            <td>:</td>
                            <td><span class="detailTable" data-detail="petugas">asdsadsad</span></td>
                        </tr>
                        <tr>
                            <td>Tanggal Undangan</td>
                            <td>:</td>
                            <td><span class="detailTable" data-detail="tanggalundangan">asdsadsad</span></td>
                        </tr>
                        <tr>
                            <td>Lama Undangan</td>
                            <td>:</td>
                            <td><span class="detailTable" data-detail="lamaundangan">asdsadsad</span></td>
                        </tr>
                        <tr>
                            <td>Tujuan Undangan</td>
                            <td>:</td>
                            <td><span class="detailTable" data-detail="tujuanundangan">asdsadsad</span></td>
                        </tr>
                        <tr>
                            <td>Tujuan Surat</td>
                            <td>:</td>
                            <td><span class="detailTable" data-detail="tujuansuratdinas">asdsadsad</span></td>
                        </tr>
                    </table>
                </div>
                <div class="noDetail" style=" background-color:rgb(244, 219, 187); padding:10px;text-align:center;color:rgb(74, 74, 74);">
                    <h4>Penomoran Tidak Memiliki Detail</h4>
                </div>
                <div id="loadingDiv" class="loadingDiv" style="display:none">
                    <div class="cons">
                        <div class="lds-ring pagering"><div></div><div></div><div></div><div></div></div>
                    </div>
                </div>
            </div>            
        </div>
    </div>
</div>


<script>
    const serverTime = `@ViewBag.CurrentDate`;

    $(document).ready(function () {
        $('.select2_single').select2({ width: 'resolve' });
        $("#srchBox").val("")
        createPagingTable()
        $('.timepicker, .swalDate fieldset').datetimepicker({
            format: 'DD/MM/YYYY',
            locale: 'id',
        });
        createArsipPagingTable()
    })

    $('.timepicker input').click(function () {
        $(this).siblings('.input-group-addon').trigger('click')
    })

    $("#inputJenisNaskah").change(function () {
        let thisval = $(this).val()

        if (!$("#detailSurat").find(`[data-details='${thisval}']`).length) {
            $(".detailsurat").hide()
        } else {
            $("#detailSurat").children().hide()
            $("#detailSurat").find(`[data-details='${thisval}']`).show()
            $(".detailsurat").show()
        }
    })

    $("#lamaundangan").change(function () {
        let thisval = $(this).val()
        if (!parseInt(thisval)) {
            $(this).parent().addClass("has-error")
        } else {
            $(this).parent().removeClass("has-error")
        }
    })

    function gunakanArsip(v) {
        $("#inputKlasArsip").val(v)
        showArsipList()
    }

    $("#srchArsipButton").click(function () {
        dtArsip.ajax.reload(null, true);
    })

    $("#formAddData").submit(function (e) {
        e.preventDefault()
    })

    $("#srcharsip").submit(function (e) {
        e.preventDefault()
        dtArsip.ajax.reload(null, true);
    })

    function showArsipList() {
        $(".formInputSection").slideToggle()
        $(".arsipList").slideToggle()
    }

    $("#srchForm").submit(function (e) {
        e.preventDefault()
        dtTables.ajax.reload(null, true);
    })

    $(".addData").on('show.bs.modal', function () {
        resetFormData()
        $("#inputJenisNaskah").val($("#slctJenisNaskah").val())
        $("#inputJenisNaskah").trigger("change")
    })

    $("#slctTahun, #slctJenisNaskah").change(function () {
        $("#srchBox").val("")
    })

    function maintablereload() {
        dtTables.ajax.reload(null, true);
    }
    let dtTables;
    let createPagingTable = function () {
        dtTables = $('#MainTable').DataTable({
            "bLengthChange": false,
            "paging": true,
            "pageLength": 15,
            "bFilter": false,
            "ordering": false,
            "info": false,
            "processing": true,
            "serverSide": true,
            "ajax": {
                url: '@Url.Action("getDataTablePenomoran", "Penomoran")',
                type: "POST",
                data: function (data) {
                    let ftp = $('#srchForm').serializeArray();
                    data.form = ftp; ftp.push(
                        { name: "draw", value: data.draw },
                        { name: "start", value: data.start },
                        { name: "length", value: data.length },
                        { name: "Bukunomorid", value: `@Model.BukuNomorId`},
                        { name: "Jenis", value: $("#slctJenisNaskah").val()},
                        { name: "Tahun", value: $("#slctTahun").val()},
                        { name: "Bulan", value: $("#slctBulan").val()},
                        { name: "StatArsip", value: $("#slctStatArsip").val()},
                        { name: "searchKey", value: $("#srchBox").val()}
                    ); return ftp;
                }
            },
            "columns": [
                { "data": "sNomorUrut", "className": "centertaligncolumn sipNum" },
                {
                    "data": null,
                    "render": function (data, type) {
                        if (data.Status == "TTE") {
                            return `<span class="nomorTTE" title="Surat Elektronik">${data.NomorSurat}</span>`
                        } else {
                            return data.NomorSurat
                        }
                    }
                },
                { "data": "Perihal", "className": "centertaligncolumn" },
                { "data": "TanggalSurat" },
                {
                    "data": null,
                    "className": "centertaligncolumn coursorPointer arsipStatus",
                    "render": function (data, type) {
                        if (data.Status == "1")
                        {
                            return `<i class="fa fa-check" style="color:green" title="Arsip Telah Diterima"></i>`
                        }
                        else if (data.Status == "TTE1")
                        {
                            return `<i class="fa fa-file" style="color:green" title="Dokumen Elektronik Sudah Ditandatangani" onclick="bukaDokumen('${data.DokumenTTE}')"></i>`
                        }
                        else if (data.Status == "TTE0")
                        {
                            return `<i class="fa fa-file" style="color:blue" title="Dokumen Elektronik Masih dalam Proses"></i>`
                        }
                        else if (data.Status == "TTE")
                        {
                            return `<div class='forDokTTE' data-nomorsurat="${data.NomorSurat}"><div class="lds-ring innertabelring"><div></div><div></div><div></div><div></div></div></div>`
                        }
                        else
                        {
                            return `<i class="fa fa-close" style="color:red" title="Arsip Belum. Klik Untuk Merubah" onclick="accArsip(this)"></i>`
                        }
                    }
                },
                {
                    "data": null,
                    "className": "centertaligncolumn",
                    "render": function (data, type) {
                        return `<button class="btn btn-warning" type="button" style="padding:1px 5px;margin:0" onclick="editPenomoran(this,'${data.Penomoranid}')"><i class="fa fa-pencil-square"></i></button>
                        <button class="btn btn-info" type="button" style="padding:1px 5px;margin:0" onclick="infoPenomoran(this,'${data.Penomoranid}')"><i class="fa fa-info-circle"></i></button>`
                    }
                }
            ],
            "drawCallback": function (settings) {
                findDokElektronik()
            }
        });
    };

    let dtArsip;
    let createArsipPagingTable = function () {
        dtArsip = $('#arsipTable').DataTable({
            "bLengthChange": false,
            "paging": true,
            "pageLength": 15,
            "bFilter": false,
            "ordering": false,
            "info": false,
            "processing": true,
            "serverSide": true,
            "ajax": {
                url: `@Url.Action("getDataTableKlasArsip", "Penomoran")`,
                type: "POST",
                data: function (data) {
                    let ftp = $('#srcharsip').serializeArray();
                    data.form = ftp; ftp.push(
                        { name: "draw", value: data.draw },
                        { name: "start", value: data.start },
                        { name: "length", value: data.length },
                        { name: "searchKey", value: $("#inputsrcharsip").val()}
                    ); return ftp;
                }
            },
            "columns": [
                { "data": "KodeKlasifikasi" },
                { "data": "JenisArsip", "className": "centertaligncolumn" },
                { "data": "Keterangan" },
                {
                    "data": null,
                    "className": "centertaligncolumn",
                    "render": function (data, type) {
                        return `<i class="fa fa-arrow-right" title="gunakan Kode Klasifikasi ini" onclick="gunakanArsip('${data.KodeKlasifikasi}')"></i>`
                    }
                }
            ]
        });
    };

    function getFormData(validate, thisBukuNomorid) {
        let formData = new FormData();
        for (let key of Object.keys(validate.main)) {
            formData.append(key, validate.main[key])
        }
        if (Object.keys(validate.details).length) {
            let keterangan = ""
            for (let key of Object.keys(validate.details)) {
                keterangan += (keterangan) ?
                    `,${key}|${validate.details[key]}` :
                    `${key}|${validate.details[key]}`
            }
            formData.append("details", keterangan)
        }
        formData.append("BukuNomorId", thisBukuNomorid)
        let status = ($('#StatusArsip').prop('checked')) ? "1" : "0"
        formData.append("Status", status)
        formData.append("Update", Update)
        if (Update) {
            formData.append("Penomoranid", PenomoranId)
            formData.append("NomorSurat", $("#UpdateNomorSurat").val())
        }
        return formData;
    }

    $('.btnadd[data-target=".addData"]').click(function () {
        Update = false;
        PenomoranId = "";
    })

    //simpan data
    function simpanDataPenomoran() {
        let thisBukuNomorid = $("#formAddData").attr("data-bukunomorid")
        let validate = validateFormInsert(thisBukuNomorid)
        if (validate) {
            let formData = getFormData(validate, thisBukuNomorid);
            if (issisip) {
                formData.append("NomorUrut", datasisip.NomorUrut)
                formData.append("BackDate", issisip)
            }
            $.ajax({
                url: '@Url.Action("InsertPenomoran", "Penomoran")',
                type: "POST",
                data: formData,
                contentType: false,
                processData: false,
                success: function (rst) {
                    if (Update) {
                        Update = false
                        PenomoranId = "";
                    }
                    if (issisip) {
                        issisip = false;
                    }
                    if (rst.status) {
                        maintablereload()
                        $(".addData").modal('hide')
                        swal('info',rst.pesan,'success')
                    } else {
                        swal('Peringatan', rst.pesan, 'warning')
                    }
                }
            });
        }
    }

    $(".wInput, .dInput").keyup(function () {
        if ($(this).parent().hasClass('has-error')) {
            $(this).parent().removeClass('has-error')
        }
    })

    //validate
    function validateFormInsert(BKID) {
        let arr = {},
            isValid = false,
            inputLength = 0,
            detailInput,
            detailArr = {}

        inputLength += $(".wInput").length

        $(".wInput").each(function () {
            if ($(this).val().trim()) {
                arr[$(this).attr('name')] = $(this).val().trim()
            } else {
                $(this).parent().addClass('has-error')
                return false;
            }
        })

        detailInput = $(`#detailSurat .formdetail[data-details='${arr["JenisNaskahDinas"]}']  .dInput`)
        if (detailInput.length) {
            inputLength += detailInput.length
            detailInput.each(function () {
                if ($(this).val().trim()) {
                    detailArr[$(this).attr('name')] = $(this).val().trim()
                } else {
                    $(this).parent().addClass('has-error')
                    return false;
                }
            })
        }


        if (inputLength == (Object.keys(arr).length + Object.keys(detailArr).length)) {
            isValid = {
                main: arr,
                details: detailArr
            }
        } else {
            isValid = false;
        }
        return isValid;
    }

    var bukaDokumen = function (id) {
        var options = { "backdrop": "static", keyboard: true };
        if (id !== null && id !== '') {
            showloading("Menyiapkan Dokumen");
            $.ajax({
                type: "POST",
                url: '@Url.Action("cekDokumen", "TandaTanganElektronik")',
                data: { id: id },
                success: function (data) {
                    if (data.Status === false) {
                        swal("Peringatan", data.Pesan, "warning")
                    }
                    else {
                        var objurl = '@Url.Action("getDokumen", "TandaTanganElektronik")?id=' + id;
                        objpdf = objurl;

                        $.ajax({
                            type: "POST",
                            url: '@Url.Action("DocViewer", "Konten")',
                            success: function (data) {
                                $('#myModalContent').html(data);
                                $('#myModalDocViewer').modal(options);
                                $('#myModalDocViewer').modal('show');
                                closeloading();
                            },
                            error: function (XMLHttpRequest, textStatus, errorThrown) {
                                swal(textStatus, "Terjadi Kesalahan \n" + errorThrown, "warning");
                            }
                        });
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    swal(textStatus, "Terjadi Kesalahan \n" + errorThrown, "warning");
                }
            });
        } else {
            swal("Peringatan", "File tidak ditemukan", "warning")
        }
    }


    function infoPenomoran(elmnt, pId) {
        $(".tabledetail tr").hide();
        $(".noDetail").hide();
        $("#loadingDiv").show()
        $(".modalinfo").modal("show")
        let data = dtTables.row($(elmnt).closest('tr')).data();
        let thisnomor = data.NomorSurat
        let thisjenis = data.JenisNaskahDinas
        $(".modalinfo .modal-title").html(thisjenis + " - " + thisnomor)
        $.ajax({
            type: "POST",
            url: '@Url.Action("GetDetailsPenomoran", "Penomoran")?penomoranid=' + pId,
            success: function (data) {
                if (data.status) {
                    for (let d of data.data) {
                        let label = d.TextKeterangan
                        let dest = $(".tabledetail tr").find(`td span[data-detail='${label}']`)
                        dest.html(d.ValueKeterangan)
                        dest.parent().parent().show()
                        $("#loadingDiv").hide()
                    }
                } else {
                    $("#loadingDiv").hide()
                    $(".noDetail").show();
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                swal(textStatus, "Terjadi Kesalahan \n" + errorThrown, "warning");
            }
        });
    }

    function resetFormData() {
        $("#detailSurat, #formAddData").find("input, textarea").each(function () {
            $(this).val("")
        })
        $("#detailSurat, #formAddData").find(".timepicker input").each(function () {
            $(this).val(serverTime)
        })
        $("#formAddData .checkbox").show();
        $("#StatusArsip").prop("checked", false)
        $("#UpdateNomorSurat").val("")
        $(".nomorInput").hide()
        $("#modaltitle").html("Tambah Data")
        $("#btnBook").show()

        $("#inputJenisNaskah").attr("disabled", false)
        $("#inputTanggalSurat").attr("disabled", false)
        datasisip = "";
        issisip = false
    }

    let Update = false
    let PenomoranId = ""
    function editPenomoran(elmnt, pId) {
        $.ajax({
            type: "POST",
            url: '@Url.Action("GetDetailsPenomoran", "Penomoran")?penomoranid=' + pId,
            success: function (rsp) {
                if (rsp.serverStatus) {
                    $(".addData").modal("show")
                    $("#modaltitle").html("Edit Data Penomoran")
                    let data = dtTables.row($(elmnt).closest('tr')).data();
                    $("#inputTanggalSurat").val(data.TanggalSurat)
                    $("#inputProfilePenandatangan").val(data.ProfilePenandatangan)
                    $("#inputPerihal").val(data.Perihal)
                    $("#inputKlasArsip").val(data.KlasifikasiArsip)
                    $("#UpdateNomorSurat").val(data.NomorSurat)
                    $(".nomorInput").show()
                    PenomoranId = pId
                    Update = true;

                    if (rsp.status) {
                        for (let d of rsp.data) {
                            let label = d.TextKeterangan
                            let dest = $("#detailSurat").find(`.dInput[name='${label}']`)
                            dest.val(d.ValueKeterangan)
                        }
                    }
                    $("#formAddData .checkbox").hide();
                    $("#btnBook").hide();
                    $("#inputJenisNaskah").attr("disabled", "disabled")
                    $("#inputTanggalSurat").attr("disabled", "disabled")
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                swal(textStatus, "Terjadi Kesalahan \n" + errorThrown, "warning");
            }
        });
    }

    function findDokElektronik() {
        let stringForm = ""
        let checkEl = $(".nomorTTE").length > 0;
        $(".nomorTTE").closest('tr').each(function () {
            let data = dtTables.row($(this).closest('tr')).data();
            stringForm += "|" + data.NomorSurat
        })
        if (checkEl) {
            $.ajax({
                type: "POST",
                url: '@Url.Action("GetDokumenElektronikByNomorSurat", "Penomoran")?list=' + encodeURI(stringForm),
                success: function (rsp) {
                    if (rsp.status) {
                        $(`.forDokTTE`).html(`
                            <i class="fa fa-close" style="color:red" title="Belum Ada data di eoffice"></i >
                        `)
                        for (let d of rsp.data) {
                            if (d.Status == "A") {
                                $(`.forDokTTE[data-nomorsurat='${d.NomorSurat}']`).html(`
                                    <i class="fa fa-file-pdf-o" style="color:#1973A8" title="Dokumen Elektronik Sudah Ditandatangani" onclick="bukaDokumen('${d.DokumenelektronikId}')"></i>
                                `)
                            } else if (d.Status == "W") {
                                $(`.forDokTTE[data-nomorsurat='${d.NomorSurat}']`).html(`
                                    <i class="fa fa-file-o" title="Dokumen Elektronik Masih dalam Proses" onclick="bukaDokumen('${d.DokumenelektronikId}')"></i>
                                `)
                            } else {
                                $(`.forDokTTE[data-nomorsurat='${d.NomorSurat}']`).html(`
                                    <i class="fa fa-close" style="color:red" title="Belum Ada data di eoffice"></i>
                                `)
                            }
                        }
                    }
                    else
                    {
                        $(`.forDokTTE`).html(`
                            <i class="fa fa-close" style="color:red" title="terdapat masalah dalam pencarian"></i>
                        `)
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    swal(textStatus, "Terjadi Kesalahan \n" + errorThrown, "warning");
                }
            });
        }
    }

    //function simpanNomorMundur() {
    //    let thisBukuNomorid = $("#formAddData").attr("data-bukunomorid")
    //    let validate = validateFormInsert(thisBukuNomorid)
    //    if (validate) {
    //        let formData = getFormData(validate, thisBukuNomorid);
    //        dateInputed = false;
    //        close = false;
    //        inputDate().then(
    //            function (value) {
    //                if (!close) {

    //                    $(".dateModal").modal("hide")
    //                }
    //            },
    //            function (error) {
    //                console.log(error)
    //            }
    //        )
    //    }
    //}

    //$(".dateAcc").click(function () {
    //    let thisval = $("#modalDatePicker").val()
    //    if (thisval) {
    //        dateInputed = true;
    //    }
    //})

    //var dateInputed = false;
    //var close = false;
    //const timeout = async ms => new Promise(res => setTimeout(res, ms));
    //async function inputDate() {
    //    $(".addData").modal("hide")
    //    $(".dateModal .textmodal").html('Masukan Tanggal Surat - <i>backdate</i>')
    //    $(".dateModal").modal("show")
    //    while (!dateInputed && !close) {
    //        await timeout(50)
    //        console.log('1')
    //    }
    //    let thisval = $("#modalDatePicker").val()
    //    return thisval;
    //}

    //$('.dateModal').on('hidden.bs.modal', function (e) {
    //    close = true;
    //})

    function bookingNomor() {
        let thisBukuNomorid = $("#formAddData").attr("data-bukunomorid")
        let validate = validateFormInsert(thisBukuNomorid)
        if (validate) {
            let formData = getFormData(validate, thisBukuNomorid);
            var book = true
            formData.append("Book", book)
            $.ajax({
                url: '@Url.Action("InsertPenomoran", "Penomoran")',
                type: "POST",
                data: formData,
                contentType: false,
                processData: false,
                success: function (rst) {
                    if (rst.status) {
                        maintablereload()
                        $(".addData").modal('hide')
                        swal('info',rst.pesan,'success')
                    } else {
                        swal('Peringatan', rst.pesan, 'warning')
                    }
                }
            });
        }
    }

    var itsopen = false;
    $("#MainTable").delegate('tbody .sipNum', 'click', function () {
        $(".popupRow").remove()
        if (!itsopen ) {
            $(this).append(`<div class="popupRow" onclick='sisip(this)'>Sisipkan Nomor</div>`)
            itsopen = true
        } else {
            itsopen = false
        }
    })

    var datasisip = ""
    var issisip = false;
    function sisip(elm) {
        let data = dtTables.row($(elm).closest('tr')).data();
        $(".addData").modal('show')
        datasisip = data
        $("#modaltitle").html("Nomor Sisip")
        $("#inputTanggalSurat").val(data.TanggalSurat)
        $("#btnBook").hide()
        issisip = true
    }

    function accArsip(el) {
        let data = dtTables.row($(el).closest('tr')).data();
        swal({
                title: "Konfirmasi Penerimaan Arsip",
                text: "Pastikan Arsip yang diterima sesuai dengan data yang terekam.",
                type: "info",
                showCancelButton: true,
                closeOnConfirm: false,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "Ya",
                cancelButtonText: "Batal",
                showLoaderOnConfirm: true
                },
                function (isConfirm) {
                    let formData = new FormData();
                    formData.append("penomoranid", data.Penomoranid)
                    $.ajax({
                        url: '@Url.Action("SerahkanArsip", "Penomoran")',
                        type: "POST",
                        data: formData,
                        contentType: false,
                        processData: false,
                        success: function (rst) {
                            if (rst.status) {
                                swal('info', rst.pesan, 'success')
                                maintablereload()
                            } else {
                                swal('Peringatan', rst.pesan, 'warning')
                            }
                        }
                    });
                }
            );
    }
</script>