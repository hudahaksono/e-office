@model Surat.Models.Entities.DraftSurat

@{
    var lstPosisiTTE = new List<SelectListItem>();
    lstPosisiTTE.Add(new SelectListItem { Text = "Halaman Terakhir", Value = "terakhir" });
    lstPosisiTTE.Add(new SelectListItem { Text = "Halaman Pertama", Value = "pertama" });
    var lstJenisTujuan = new List<SelectListItem>();
    lstJenisTujuan.Add(new SelectListItem { Text = "Internal ATR/BPN", Value = "bpn" });
    lstJenisTujuan.Add(new SelectListItem { Text = "External", Value = "lain" });
    var lstTipeSurat = new List<SelectListItem>();
    lstTipeSurat.Add(new SelectListItem { Text = "Nota Dinas", Value = "Nota Dinas" });
    lstTipeSurat.Add(new SelectListItem { Text = "Surat Undangan", Value = "Surat Undangan" });
    var lstnull = new List<SelectListItem>();
}
<script src='@Url.Content("~/resources/js/jquery.form.js")' type="text/javascript"></script>
<script src='@Url.Content("~/resources/js/jqueryautocomplete/jquery.autocomplete.js")' type="text/javascript"></script>
<script src='@Url.Content("~/resources/js/nicEdit-latest.js")'></script>

<style>
    .formisian {
        max-width: 350px;
    }

    .formfull {
        width: 100%;
    }

    .date {
        max-width: 200px;
    }

    .btn-file {
        position: relative;
        overflow: hidden;
    }

        .btn-file input[type=file] {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 100px;
            text-align: right;
            filter: alpha(opacity=0);
            opacity: 0;
            background: red;
            cursor: inherit;
            display: block;
        }

    .switch {
        position: relative;
        display: inline-block;
        width: 80px;
        height: 34px;
    }

        .switch input {
            display: none;
        }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
    }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }

    /* include generated hidden field here */
    input[type="checkbox"]:checked + input[type="hidden"] + .slider,
    input[type="checkbox"]:checked + .slider {
        background-color: #2196F3;
    }

    /* include generated hidden field here */
    input[type="checkbox"]:focus + input[type="hidden"] + .slider,
    input[type="checkbox"]:focus + .slider {
        box-shadow: 0 0 1px #2196F3;
    }

    /* include generated hidden field here */
    input[type="checkbox"]:checked + input[type="hidden"] + .slider:before,
    input[type="checkbox"]:checked + .slider:before {
        transform: translateX(46px);
    }

    /* Rounded sliders */
    .slider.round {
        border-radius: 24px;
    }

        .slider.round:before {
            border-radius: 50%;
        }

    .error {
        color: #ad1010;
        font-family: 'Varela Round', sans-serif;
        font-style: oblique;
    }
</style>
<script type="text/javascript">
    $(function () {
        $.validator.unobtrusive.parse(this);
    });
</script>
<div class="">
    <div class="page-title">
        <div class="title_left"><h2 style="width:100%"><span id="LabelTitle">Editor Konsep Surat - <b>@ViewBag.Judul</b></span></h2></div>
        <div class="title_right" style="text-align:right;">
            <div class="pull-right">
                <span class="input-group-btn" style="padding-right:2px;">
                    @if (@OtorisasiUser.isTU())
                    {
                        if (string.IsNullOrEmpty(Model.DraftCode))
                        {
                            <button type="button" id="btnsimpandankirim" class="btn btn-primary">Kirim Konsep</button>
                        }
                        else
                        {
                            <button type="button" id="btnsetujudankirim" class="btn btn-primary"><i class="fa fa-check-square-o"></i>&nbsp;Terima Konsep</button>
                            <button type="button" id="btntolak" class="btn btn-danger"><i class="fa fa-ban"></i>&nbsp;Tolak Konsep</button>
                        }
                    }
                    else
                    {
                        if (string.IsNullOrEmpty(Model.DraftCode))
                        {
                            <button type="button" id="btnsimpan" class="btn btn-primary">Ajukan Konsep</button>
                        }
                        else
                        {
                            if (Model.Status.Equals("P"))
                            {
                                <button type="button" id="btnsimpan" class="btn btn-primary">Ajukan Konsep</button>
                            }
                            else
                            {
                                <button type="button" id="btnsimpan" class="btn btn-primary">Infokan Perubahan</button>
                            }
                            <button type="button" id="btntolak" class="btn btn-danger"><i class="fa fa-times-square-o"></i>&nbsp;Batalkan Konsep</button>
                        }
                    }
                    <button id="cancel-btn" type="button" class="btn btn-warning" onclick="history.back();">Kembali</button>
                </span>
            </div>
        </div>
    </div>

    <div class="row x_panel tile" style="padding-top:7px; border:1px solid #E6E9ED;">
        <div class="x_content">
            <div class="" role="tabpanel" data-example-id="togglable-tabs" id="tabs">
                <ul id="actTabs" class="nav nav-tabs hidden-print" role="tablist">
                    <li role="presentation" class="active">
                        <a href="#tab1" role="tab" id="step1-tab" data-toggle="tab" aria-expanded="true">Pengenal</a>
                    </li>
                    <li role="presentation" class="" id="tabStep2">
                        <a href="#tab2" role="tab" id="step2-tab" data-toggle="tab" aria-expanded="false">Isi</a>
                    </li>
                    <li role="presentation" class="" id="tabStep3">
                        <a href="#tab3" role="tab" id="step3-tab" data-toggle="tab" aria-expanded="false">Lampiran</a>
                    </li>
                    @if (@OtorisasiUser.isTU())
                    {
                        <li role="presentation" class="" id="tabStep4">
                            <a href="#tab4" role="tab" id="step4-tab" data-toggle="tab" aria-expanded="false">Penandatangan</a>
                        </li>
                    }
                    <li role="presentation" class="" id="tabStep5">
                        <a href="#tab5" role="tab" id="step5-tab" data-toggle="tab" aria-expanded="false">Tampilan</a>
                    </li>
                </ul>
            </div>
            <div id="tab-content" class="tab-content">
                <div role="tabpanel" class="tab-pane fade active in" id="tab1" aria-labelledby="step1-tab">
                    <div class="x_panel">
                        <div class="x_title">
                            <h2>Pengenal Dokumen</h2>
                            @Html.HiddenFor(m => m.DraftCode)
                            @Html.HiddenFor(m => m.UnitKerjaId)
                            @Html.HiddenFor(m => m.isTU)
                            <span class="input-group-btn pull-right" style="padding-right:2px;">
                                <button type="button" class="btn btn-success pull-right" onclick="goStep(1,2)">Berikutnya</button>
                            </span>
                            <div class="clearfix"></div>
                        </div>
                        <div class="x_content">
                            <form data-parsley-validate id="frmStep1" role="form" method="post">
                                <div class="row">
                                    <div class="col-md-4 col-sm-4 col-xs-12">
                                        <div class="form-group">
                                            <label class="control-label" for="tipesurat">Tipe Surat <span style="color:red">*</span></label>
                                            @Html.DropDownListFor(model => model.TipeSurat, lstTipeSurat, new { @class = "select2_single form-control input-md", @id = "tipesurat", @required = "required" })
                                            <small>@Html.ValidationMessageFor(model => model.TipeSurat, "", new { @class = "error" })</small>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label" for="sifatsurat">Sifat Surat <span style="color:red">*</span></label>
                                            @Html.DropDownListFor(model => model.SifatSurat, lstnull, new { @class = "select2_single form-control input-md", @id = "sifatsurat", @required = "required" })
                                            <small>@Html.ValidationMessageFor(model => model.SifatSurat, "", new { @class = "error" })</small>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label" for="kodearsip">Kode Arsip <span style="color:red">*</span></label>
                                            @Html.TextBoxFor(model => model.KodeArsip, new { @class = "form-control formfull", @id = "kodearsip", @maxlength = "10", @required = "required" })
                                            <small>@Html.ValidationMessageFor(model => model.KodeArsip, "", new { @class = "error" })</small>
                                        </div>
                                    </div>
                                    <div class="col-md-8 col-sm-8 col-xs-12">
                                        <div class="form-group">
                                            <label class="control-label" for="ProfilePengirim">Pengirim Surat <span style="color:red">*</span></label>
                                            @Html.DropDownListFor(model => model.ProfilePengirim, Model.ListProfile, new { @class = "select2_single form-control input-md", @required = "required" })
                                            <small>@Html.ValidationMessageFor(model => model.ProfilePengirim, "", new { @class = "error" })</small>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label" for="perihal">Hal <span style="color:red">*</span></label>
                                            @Html.TextAreaFor(model => model.Perihal, new { @class = "form-control formfull", @id = "perihal", @rows = 5, @required = "required" })
                                            <small>@Html.ValidationMessageFor(model => model.Perihal, "", new { @class = "error" })</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 col-sm-6 col-xs-12">
                                        <div class="x_title">
                                            <h2 class="mytitleform">Tujuan <span style="color:red">*</span></h2>
                                            <div class="clearfix"></div>
                                        </div>
                                        <div class="form-group">
                                            @Html.DropDownList("jenistujuan", lstJenisTujuan, new { @class = "select2_single form-control formfull", @onchange = "tujuansuratberubah()" })
                                        </div>
                                        <div class="form-group" id="div_tujuanEX">
                                            <div class="input-group" style="margin-bottom:0px">
                                                @Html.TextBox("tujuanEX", "", new { @class = "form-control", type = "text" })
                                                <div class="input-group-btn">
                                                    <label class="btn btn-success" style="margin-right:0" onclick="tambahtujuan('ex','text')">
                                                        <i class="fa fa-plus"></i>&nbsp;Tambah
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group" id="div_tujuanIN">
                                            <div class="input-group" style="margin-bottom:0px">
                                                @Html.DropDownList("tujuanIN", lstnull, new { @class = "select2_single form-control formfull" })
                                                <div class="input-group-btn">
                                                    <label class="btn btn-success" style="margin-right:0" onclick="tambahtujuan('in','text')">
                                                        <i class="fa fa-plus"></i>&nbsp;Jabatan
                                                    </label>
                                                    <label class="btn btn-primary" style="margin-right:0" onclick="tambahtujuan('in','value')">
                                                        <i class="fa fa-plus"></i>&nbsp;Nama
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <table class="table table-striped table-bordered" style="width:100%;margin-bottom:0px;">
                                                <tr>
                                                    <th>Nama Tujuan</th>
                                                    <th style="width:57px"></th>
                                                </tr>
                                            </table>
                                            <div class="table-responsive" style="margin-bottom:0px;overflow-y:scroll;height:180px;">
                                                <table id="tblTujuanSurat" class="table table-striped table-bordered" style="width:100%;">
                                                    <tbody id="datatujuan"><tr><td colspan="2" style="text-align:center;">Tujuan Kosong</td></tr></tbody>
                                                </table>
                                            </div>
                                            @Html.Hidden("ListTujuanSurat")
                                        </div>
                                        <small id="tujuansurat" class="error">Tujuan Surat Kosong</small>
                                    </div>
                                    <div class="col-md-6 col-sm-6 col-xs-12">
                                        <div class="x_title">
                                            <h2 class="mytitleform">Tembusan</h2>
                                            <div class="clearfix"></div>
                                        </div>
                                        <div class="form-group">
                                            @Html.DropDownList("jenistembusan", lstJenisTujuan, new { @class = "select2_single form-control formfull", @onchange = "tembusansuratberubah()" })
                                        </div>
                                        <div class="form-group" id="div_tembusanEX">
                                            <div class="input-group" style="margin-bottom:0px">
                                                @Html.TextBox("tembusanEX", "", new { @class = "form-control", type = "text" })
                                                <div class="input-group-btn">
                                                    <label class="btn btn-success" style="margin-right:0" onclick="tambahtembusan('ex','text')">
                                                        <i class="fa fa-plus"></i>&nbsp;Tambah
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group" id="div_tembusanIN">
                                            <div class="input-group" style="margin-bottom:0px">
                                                @Html.DropDownList("tembusanIN", lstnull, new { @class = "select2_single form-control formfull" })
                                                <div class="input-group-btn">
                                                    <label class="btn btn-success" style="margin-right:0" onclick="tambahtembusan('in','text')">
                                                        <i class="fa fa-plus"></i>&nbsp;Jabatan
                                                    </label>
                                                    <label class="btn btn-primary" style="margin-right:0" onclick="tambahtembusan('in','value')">
                                                        <i class="fa fa-plus"></i>&nbsp;Nama
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <table class="table table-striped table-bordered" style="width:100%;margin-bottom:0px;">
                                                <tr>
                                                    <th>Nama Tembusan</th>
                                                    <th style="width:57px"></th>
                                                </tr>
                                            </table>
                                            <div class="table-responsive" style="margin-bottom:0px;overflow-y:scroll;height:180px;">
                                                <table id="tblTembusanSurat" class="table table-striped table-bordered" style="width:100%;">
                                                    <tbody id="datatembusan"><tr><td colspan="2" style="text-align:center;">Tembusan Kosong</td></tr></tbody>
                                                </table>
                                            </div>
                                            @Html.Hidden("ListTembusanSurat")
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div role="tabpanel" class="tab-pane fade" id="tab2" aria-labelledby="step2-tab">
                    <div class="x_panel">
                        <div class="x_title">
                            <h2>Isi Surat</h2>
                            <span class="input-group-btn pull-right" style="padding-right:2px;">
                                <button type="button" class="btn btn-success pull-right" onclick="goStep(2,3)">Berikutnya</button>
                            </span>
                            <div class="clearfix"></div>
                        </div>
                        <div class="x_content">
                            <form data-parsley-validate id="frmStep2" role="form" method="post">
                                <div class="col-md-12 col-sm-12 col-xs-12">
                                    <div class="form-group">
                                        <div id="myNicPanel" style="width: 525px;"></div>
                                        <p id="editor" style="border: 1px solid #000;height:300px;overflow:auto;">

                                        </p>
                                    </div>
                                </div>
                                <small id="ErrIsiSurat" class="error">Isi Surat Kosong</small>
                            </form>
                        </div>
                    </div>
                </div>
                <div role="tabpanel" class="tab-pane fade" id="tab3" aria-labelledby="step-tab">
                    <div class="x_panel">
                        <div class="x_title">
                            <h2>Lampiran</h2>
                            <span class="input-group-btn pull-right" style="padding-right:2px;">
                                @if (@OtorisasiUser.isTU())
                                {
                                    <button type="button" class="btn btn-success pull-right" onclick="goStep(3,4)">Berikutnya</button>
                                }
                                else
                                {
                                    <button type="button" class="btn btn-success pull-right" onclick="goStep(3,5)">Berikutnya</button>
                                }
                            </span>
                            <div class="clearfix"></div>
                        </div>
                        <div class="x_content">
                            <form data-parsley-validate id="frmStep3" role="form" method="post">
                                <div class="form-group">
                                    <label class="control-label" for="kopsurat">Kop Surat <span style="color:red">*</span></label>
                                    @if (@OtorisasiUser.isTU())
                                    {
                                        <div class="input-group" style="margin-bottom:0px">
                                            @Html.DropDownListFor(model => model.KopSurat, Model.ListKodeKopSurat, new { @class = "form-control formfull", @id = "kopsurat", @required = "required" })
                                            <div class="input-group-btn">
                                                <label class="btn btn-success" style="margin-right:0" onclick="EditKop()">
                                                    <i class="fa fa-pencil"></i>&nbsp;Ubah
                                                </label>
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        @Html.DropDownListFor(model => model.KopSurat, Model.ListKodeKopSurat, new { @class = "form-control formfull", @id = "kopsurat", @required = "required" })
                                    }
                                    <small>@Html.ValidationMessageFor(model => model.KopSurat, "", new { @class = "error" })</small>
                                </div>
                                <div class="form-group" id="divUpload">
                                    @Html.HiddenFor(m => m.LampiranId)
                                    <div class="input-group" style="margin-bottom:0px">
                                        @Html.TextBoxFor(model => model.NamaFileLampiran, new { @class = "form-control", id = "namafile", type = "text", @readonly = "readonly", @onclick = "$('#btnUploadFile').click();" })
                                        <div class="input-group-btn">
                                            <label class="btn btn-success btn-file">
                                                <i class="fa fa-search"></i><input class="" type="file" name="filename" id="btnUploadFile" accept=".pdf" hidden style="width:70px;">
                                            </label>
                                        </div>
                                    </div>
                                    <small><span id="validFile" class="error"></span></small>
                                </div>
                                <div id='fileDokumen'></div>
                            </form>
                        </div>
                    </div>
                </div>
                @if (@OtorisasiUser.isTU())
                {
                    <div role="tabpanel" class="tab-pane fade" id="tab4" aria-labelledby="step4-tab">
                        <div class="x_panel">
                            <div class="x_title">
                                <h2>Penandatangan</h2>
                                <span class="input-group-btn pull-right" style="padding-right:2px;">
                                    <button type="button" class="btn btn-success pull-right" onclick="goStep(4,5)">Berikutnya</button>
                                </span>
                                <div class="clearfix"></div>
                            </div>
                            <div class="x_content">
                                <form data-parsley-validate id="frmStep4" role="form" method="post">
                                    <div class="col-md-12 col-sm-12 col-xs-12">
                                        <div class="form-group">
                                            <table class="table table-striped table-bordered" style="width:100%;margin-bottom:0px;">
                                                <tr>
                                                    <th style="width:152px">NIP</th>
                                                    <th style="width:123px">Nama</th>
                                                    <th>Jabatan</th>
                                                    <th style="width:100px">Tipe</th>
                                                    <th style="width:57px"></th>
                                                </tr>
                                            </table>
                                            <div class="table-responsive" style="margin-bottom:0px;overflow-y:scroll;height:200px;">
                                                <table id="tblPenandatangan" class="table table-striped table-bordered" style="width:100%;">
                                                    <tbody id="datatte"><tr><td colspan="5" style="text-align:center;">Penandatangan Kosong</td></tr></tbody>
                                                </table>
                                            </div>
                                            @Html.Hidden("UserTTE")
                                        </div>
                                        <small id="ErrPenandatangan" class="error">Penandatangan Kosong</small>
                                    </div>
                                    <div class="col-md-12 col-sm-12 col-xs-12">
                                        <div class="form-group">
                                            <button id="BtnTambahTandaTangan" type="button" class="btn btn-success pull-right"><i class="fa fa-plus"></i> Tanda Tangan</button>
                                            <button id="BtnTambahParaf" type="button" class="btn btn-success pull-right"><i class="fa fa-plus"></i> Paraf</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                }
                <div role="tabpanel" class="tab-pane fade" id="tab5" aria-labelledby="step5-tab">
                    <div class="x_panel">
                        <div class="x_title">
                            <h2>Tampilan Dokumen</h2>
                            <span class="input-group-btn pull-right" style="padding-right:2px;">
                                <button id="preview-btn" type="button" class="btn btn-warning pull-right" onclick="DoTampilkanDokumen()">Simpan dan Tampilkan Draft</button>
                            </span>
                            <div class="clearfix"></div>
                        </div>
                        <div class="x_content">
                            <form data-parsley-validate id="frmStep5" role="form" method="post">
                                <div class="col-md-3 col-sm-6 col-xs-12" style="display:none;">
                                    <div class="form-group">
                                        <label class="control-label" for="posisitte">Posisi TTE <span style="color:red">*</span></label>
                                        @Html.DropDownListFor(model => model.PosisiTTE, lstPosisiTTE, new { @class = "form-control formfull", @id = "posisitte", @required = "required" })
                                        <small>@Html.ValidationMessageFor(model => model.PosisiTTE, "", new { @class = "error" })</small>
                                    </div>
                                </div>
                                <div class="col-md-12 col-sm-12 col-xs-12">
                                    <div id='tampilanDokumen'></div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id='ListPegawaiModal' class='modal'>
    <div class="modal-dialog">
        <div class="modal-content">
            <div id='myModalContent'>
                <div class="col-md-12 col-sm-12 col-xs-12">
                    <div class="x_panel" style="padding:20px">
                        <div class="x_title">
                            <h2 id="popuptitle">Daftar Pegawai</h2>
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="fa fa-times"></i></button>
                            <div class="clearfix"></div>
                        </div>
                        <div class="x_content">
                            <div class="row">
                                <div class="table-responsive" style="padding-right:10px;">
                                    <form id="frmDaftarPegawai">
                                        <div class="form-group">
                                            <label class="control-label" for="txtJabatan">Jabatan</label>
                                            @Html.TextBox("txtJabatan", "", new { @class = "form-control" })
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label" for="txtNama">Nama</label>
                                            @Html.TextBox("txtNama", "", new { @class = "form-control" })
                                        </div>
                                        <div class="form-group">
                                            <button type="button" class="btn btn-success" id="btncaripegawai">Cari</button>
                                            <button type="button" class="btn btn-warning" data-dismiss="modal">Batal</button>
                                        </div>
                                    </form>
                                    <table id="myTableDaftarPegawai" class="table table-striped hover" style="width:100%;">
                                        <thead>
                                            <tr>
                                                <th style="width:5%">#</th>
                                                <th>NIP</th>
                                                <th>Nama</th>
                                                <th>Jabatan</th>
                                                <th style="width:10%">Pilih</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id='DesainKopModal' class='modal'>
    <div class="modal-dialog">
        <div class="modal-content">
            <div id='kopContent'>
            </div>
        </div>
    </div>
</div>



<script src='@Url.Content("~/resources/js/pdfobject.min.js")'></script>
<script type="text/javascript">
    $(function () {
        bkLib.onDomLoaded(function () {
            var myNicEditor = new nicEditor({
                buttonList: ['table', 'bold', 'italic', 'underline', 'ol', 'ul', 'hr', 'strikeThrough', 'subscript', 'superscript', 'xhtml'],
                maxHeight: 300
            });
            myNicEditor.setPanel('myNicPanel');
            myNicEditor.addInstance('editor');
        });
    });

    var $listTujuan = "";
    var $listTembusan = "";
    var dfFileDokumen = null;
    var tte = "0";

    $("#BtnTambahParaf").on("click", function (e) {
        tte = "0"
        $("#txtJabatan").val("");
        $("#txtNama").val("");
        dtableDaftarPegawai.ajax.reload(null, true);
        $('#popuptitle').html('Daftar Pegawai');
        $('#ListPegawaiModal').modal('show');

        e.preventDefault();
        return false;
    });

    $("#BtnTambahTandaTangan").on("click", function (e) {
        tte = "1"
        $("#txtJabatan").val("");
        $("#txtNama").val("");
        dtableDaftarPegawai.ajax.reload(null, true);
        $('#popuptitle').html('Daftar Pegawai');
        $('#ListPegawaiModal').modal('show');
        $('#ErrPenandatangan').hide();

        e.preventDefault();
        return false;
    });

    $("#btncaripegawai").on("click", function (e) {
        dtableDaftarPegawai.ajax.reload(null, true);
    });

    function EditKop() {
        $.ajax({
            type: "POST",
            url: '@Url.Action("SettingKopSurat", "Surat")',
            data: { id: $("#kopsurat").val()},
            success: function (data, textStatus, XMLHttpRequest) {
                if (data == 'noresults') {
                    swal("Peringatan", "Data Kop surat tidak ditemukan", "warning")
                }
                else {
                    $('#kopContent').html(data);
                    $('#DesainKopModal').modal('show');
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) { $.unblockUI(); }
        });
    }

    $("#btnsimpan").on("click", function (e) {
        $.blockUI({ message: '<div style=\"padding:10px\"><b>Sedang proses... </b><p>harap tunggu</p></div>' });
        var frmdata = new FormData();
        var canSave = true;

        if ($("#frmStep1").valid()) {
            recheckTujuan();
            recheckTembusan();
            if ($('#ListTujuanSurat').val() == "") {
                canSave = false;
                $('#tujuansurat').show();
                showalert("Tujuan Surat Harus Dipilih");
                $.unblockUI();
                return false;
            }
            frmdata.append("DraftCode", $('#DraftCode').val());
            frmdata.append("TipeSurat", $('#tipesurat').val());
            frmdata.append("SifatSurat", $('#sifatsurat').val());
            frmdata.append("KodeArsip", $('#kodearsip').val());
            frmdata.append("listTujuan", $('#ListTujuanSurat').val());
            frmdata.append("listTembusan", $('#ListTembusanSurat').val());
            frmdata.append("Perihal", $('#perihal').val());
            frmdata.append("ProfilePengirim", $('#ProfilePengirim').val());
        } else {
            canSave = false;
            showalert("Bagian 'Pengenal' Surat Belum Lengkap");
            $.unblockUI();
            return false;
        }

        if ($("#frmStep2").valid()) {
            if ($('#editor').html().trim() == "") {
                canSave = false;
                $('#ErrIsiSurat').show();
                showalert("Isi Surat Harus Diisi");
                $.unblockUI();
                return false;
            }
            frmdata.append("IsiSurat", encodeURI($('#editor').html().trim()));
        } else {
            canSave = false;
            showalert("Isi Surat Harus Diisi");
            $.unblockUI();
            return false;
        }

        if ($("#frmStep3").valid()) {
            if (dfFileDokumen !== null) {
                var namafile = dfFileDokumen.name;
                var fileExt = '.' + namafile.toLowerCase().split('.').pop();
                if (fileExt !== null && fileExt !== '') {
                    if (fileExt != ".pdf") {
                        $.unblockUI();
                        showalert("File harus pdf");
                        return false;
                    }
                    frmdata.append("NamaFileLampiran", namafile);
                    frmdata.append("EkstensiLampiran", fileExt);
                    frmdata.append("FileLampiran", dfFileDokumen);
                }
                else {
                    swal("Peringatan", "File Lampiran tidak diketemukan", "warning")
                    canSave = false;
                }
            }
            frmdata.append("KopSurat", $('#kopsurat').val());
        } else {
            canSave = false;
        }

        var pesan = "Lakukan Pengajuan Konsep Surat?";
        if ($('#DraftCode').val() != null && $('#DraftCode').val() != "" && $('#btnsimpan').html() != "Ajukan Konsep" ) {
            pesan = "Lakukan Pengajuan Perbaikan Konsep Surat?";
        }

        if (canSave) {
            $.unblockUI();
            swal({
                title: "Konfirmasi Simpan Konsep",
                text: pesan,
                type: "info",
                showCancelButton: true,
                closeOnConfirm: false,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "Ya",
                cancelButtonText: "Batal",
                showLoaderOnConfirm: true
            },
                function (isConfirm) {
                    if (isConfirm) {
                        $.ajax({
                            url: '@Url.Action("SimpanDraftNaskahDinas", "Surat")',
                            type: "POST",
                            data: frmdata,
                            contentType: false,
                            processData: false,
                            success: function (data, textStatus, jqXHR) {
                                if (data && data.Status) {
                                    $.ajax({
                                        url: '@Url.Action("PengajuanDraft", "Surat")',
                                        type: "POST",
                                        data: {id : data.Pesan},
                                        success: function (rst, textStatus, jqXHR) {
                                            if (rst && rst.Status) {
                                                swal({
                                                    title: "Informasi",
                                                    text: " Konsep Surat Telah Diajukan",
                                                    type: "success",
                                                    timer: 1000,
                                                    showConfirmButton: false
                                                }, function () {
                                                    window.location.href = '@Url.Action("ListDraft", "Surat")';
                                                });
                                            }
                                            else {
                                                swal("Peringatan", rst.Pesan, "warning")
                                            }
                                        },
                                        error: function (jqXHR, textStatus, errorThrown) { showmsg("Error", errorThrown); $.unblockUI(); }
                                    });
                                }
                                else {
                                    swal("Peringatan", data.Pesan, "warning")
                                }
                            },
                            error: function (jqXHR, textStatus, errorThrown) { showmsg("Error", errorThrown); $.unblockUI(); }
                        });
                    }
                });
        } else {
            swal("Peringatan", "Isian Belum Lengkap", "warning")
            $.unblockUI();
        }

        e.preventDefault();
        return false;
    });

    $("#btnsetujudankirim").on("click", function (e) {
        $.blockUI({ message: '<div style=\"padding:10px\"><b>Sedang proses... </b><p>harap tunggu</p></div>' });
        var frmdata = new FormData();
        var canSave = true;

        if ($("#frmStep1").valid()) {
            recheckTujuan();
            recheckTembusan();
            if ($('#ListTujuanSurat').val() == "") {
                canSave = false;
                $('#tujuansurat').show();
                showalert("Tujuan Surat Harus Dipilih");
                $.unblockUI();
                return false;
            }
            frmdata.append("DraftCode", $('#DraftCode').val());
            frmdata.append("TipeSurat", $('#tipesurat').val());
            frmdata.append("SifatSurat", $('#sifatsurat').val());
            frmdata.append("KodeArsip", $('#kodearsip').val());
            frmdata.append("listTujuan", $('#ListTujuanSurat').val());
            frmdata.append("listTembusan", $('#ListTembusanSurat').val());
            frmdata.append("Perihal", $('#perihal').val());
            frmdata.append("ProfilePengirim", $('#ProfilePengirim').val());
        } else {
            canSave = false;
            showalert("Bagian 'Pengenal' Surat Belum Lengkap");
            $.unblockUI();
            return false;
        }

        if ($("#frmStep2").valid()) {
            if ($('#editor').html().trim() == "") {
                canSave = false;
                $('#ErrIsiSurat').show();
                showalert("Isi Surat Harus Diisi");
                $.unblockUI();
                return false;
            }
            frmdata.append("IsiSurat", encodeURI($('#editor').html().trim()));
        } else {
            canSave = false;
            showalert("Isi Surat Harus Diisi");
            $.unblockUI();
            return false;
        }

        if ($("#frmStep3").valid()) {
            if (dfFileDokumen !== null) {
                var namafile = dfFileDokumen.name;
                var fileExt = '.' + namafile.toLowerCase().split('.').pop();
                if (fileExt !== null && fileExt !== '') {
                    if (fileExt != ".pdf") {
                        $.unblockUI();
                        showalert("File harus pdf");
                        return false;
                    }
                    frmdata.append("NamaFileLampiran", namafile);
                    frmdata.append("EkstensiLampiran", fileExt);
                    frmdata.append("FileLampiran", dfFileDokumen);
                }
                else {
                    swal("Peringatan", "File Lampiran tidak diketemukan", "warning")
                    canSave = false;
                }
            }
            frmdata.append("KopSurat", $('#kopsurat').val());
        } else {
            canSave = false;
        }

        if ($('#isTU').val() == "True") {
            if ($("#frmStep4").valid()) {
                recheckPenandatangan();
                var metadata = $('#UserTTE').val();
                if (metadata == "") {
                    $.unblockUI();
                    $('#ErrPenandatangan').show();
                    showalert("Penandatangan Harus Dipilih");
                    return false;
                }
                frmdata.append("listTTE", metadata);
            } else {
                canSave = false;
            }
        }

        if (canSave) {
            $.unblockUI();
            frmdata.append("PosisiTTE", $('#posisitte').val());
            swal({
                title: "Konfirmasi Setuju Pengajuan",
                text: "No. Konsep : " + $('#DraftCode').val() + "\nHarap masukkan PassPhrase anda",
                type: "input",
                inputType: "password",
                showCancelButton: true,
                closeOnConfirm: false,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "Ya",
                cancelButtonText: "Batal",
                inputPlaceholder: "Kosongkan untuk Setujui tanpa memberikan paraf",
                showLoaderOnConfirm: true
            },
                function (inputValue) {
                    if (inputValue === false) return false;
                    frmdata.append("Pass", inputValue);
                    $.ajax({
                        url: '@Url.Action("SimpanDraftNaskahDinas", "TandaTanganElektronik")',
                        type: "POST",
                        data: frmdata,
                        contentType: false,
                        processData: false,
                        success: function (data, textStatus, jqXHR) {
                            if (data && data.Status) {
                                $.ajax({
                                    url: '@Url.Action("PembuatanSurat", "Surat")',
                                    type: "POST",
                                    data: { id: data.Pesan, tp: $('#tipesurat').val(), ps: inputValue },
                                    success: function (rst, textStatus, jqXHR) {
                                        if (rst && rst.Status) {
                                            swal({
                                                title: "Informasi",
                                                text: "Surat Berhasil Dibuat",
                                                type: "success",
                                                timer: 1000,
                                                showConfirmButton: false
                                            }, function () {
                                                window.location.href = '@Url.Action("PengajuanTTE", "TandaTanganElektronik")';
                                            });
                                        }
                                        else {
                                            swal("Peringatan", rst.Pesan, "warning")
                                        }
                                    },
                                    error: function (jqXHR, textStatus, errorThrown) { showmsg("Error", errorThrown); $.unblockUI(); }
                                });
                            }
                            else {
                                swal("Peringatan", data.Pesan, "warning")
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) { showmsg("Error", errorThrown); $.unblockUI(); }
                    });
                });
        }
        else {
            swal("Peringatan", 'Data input wajib belum Anda masukkan', "warning")
        }

        e.preventDefault();
        return false;
    });

    $("#btnsimpandankirim").on("click", function (e) {
        $.blockUI({ message: '<div style=\"padding:10px\"><b>Sedang proses... </b><p>harap tunggu</p></div>' });
        var frmdata = new FormData();
        var canSave = true;

        if ($("#frmStep1").valid()) {
            recheckTujuan();
            recheckTembusan();
            if ($('#ListTujuanSurat').val() == "") {
                canSave = false;
                $('#tujuansurat').show();
                showalert("Tujuan Surat Harus Dipilih");
                $.unblockUI();
                return false;
            }
            frmdata.append("DraftCode", $('#DraftCode').val());
            frmdata.append("TipeSurat", $('#tipesurat').val());
            frmdata.append("SifatSurat", $('#sifatsurat').val());
            frmdata.append("KodeArsip", $('#kodearsip').val());
            frmdata.append("listTujuan", $('#ListTujuanSurat').val());
            frmdata.append("listTembusan", $('#ListTembusanSurat').val());
            frmdata.append("Perihal", $('#perihal').val());
            frmdata.append("ProfilePengirim", $('#ProfilePengirim').val());
        } else {
            canSave = false;
            showalert("Bagian 'Pengenal' Surat Belum Lengkap");
            $.unblockUI();
            return false;
        }

        if ($("#frmStep2").valid()) {
            if ($('#editor').html().trim() == "") {
                canSave = false;
                $('#ErrIsiSurat').show();
                showalert("Isi Surat Harus Diisi");
                $.unblockUI();
                return false;
            }
            frmdata.append("IsiSurat", encodeURI($('#editor').html().trim()));
        } else {
            canSave = false;
            showalert("Isi Surat Harus Diisi");
            $.unblockUI();
            return false;
        }

        if ($("#frmStep3").valid()) {
            if (dfFileDokumen !== null) {
                var namafile = dfFileDokumen.name;
                var fileExt = '.' + namafile.toLowerCase().split('.').pop();
                if (fileExt !== null && fileExt !== '') {
                    if (fileExt != ".pdf") {
                        $.unblockUI();
                        showalert("File harus pdf");
                        return false;
                    }
                    frmdata.append("NamaFileLampiran", namafile);
                    frmdata.append("EkstensiLampiran", fileExt);
                    frmdata.append("FileLampiran", dfFileDokumen);
                }
                else {
                    swal("Peringatan", "File Lampiran tidak diketemukan", "warning")
                    canSave = false;
                }
            }
            frmdata.append("KopSurat", $('#kopsurat').val());
        } else {
            canSave = false;
        }

        if ($("#frmStep4").valid()) {
            recheckPenandatangan();
            var metadata = $('#UserTTE').val();
            if (metadata == "") {
                $.unblockUI();
                $('#ErrPenandatangan').show();
                showalert("Penandatangan Harus Dipilih");
                return false;
            }
            frmdata.append("listTTE", metadata);
        } else {
            canSave = false;
        }

        if (canSave) {
            $.unblockUI();
            frmdata.append("PosisiTTE", $('#posisitte').val());
            swal({
                title: "Konfirmasi Pembuatan Dokumen",
                text: "Kirim Surat untuk di Tandatangani\nHarap masukkan PassPhrase anda",
                type: "input",
                inputType: "password",
                showCancelButton: true,
                closeOnConfirm: false,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "Ya",
                cancelButtonText: "Batal",
                inputPlaceholder: "Kosongkan untuk kirim tanpa memberikan paraf",
                showLoaderOnConfirm: true
            },
                function (inputValue) {
                    if (inputValue === false) return false;
                    frmdata.append("Pass", inputValue);
                    $.ajax({
                        url: '@Url.Action("SimpanDraftNaskahDinas", "TandaTanganElektronik")',
                        type: "POST",
                        data: frmdata,
                        contentType: false,
                        processData: false,
                        success: function (data, textStatus, jqXHR) {
                            if (data && data.Status) {
                                $.ajax({
                                    url: '@Url.Action("PembuatanSurat", "Surat")',
                                    type: "POST",
                                    data: { id: data.Pesan, tp: $('#tipesurat').val(), ps: inputValue },
                                    success: function (rst, textStatus, jqXHR) {
                                        if (rst && rst.Status) {
                                            swal({
                                                title: "Informasi",
                                                text: "Surat Berhasil Dibuat",
                                                type: "success",
                                                timer: 1000,
                                                showConfirmButton: false
                                            }, function () {
                                                window.location.href = '@Url.Action("PengajuanTTE", "TandaTanganElektronik")';
                                            });
                                        }
                                        else {
                                            swal("Peringatan", rst.Pesan, "warning")
                                        }
                                    },
                                    error: function (jqXHR, textStatus, errorThrown) { showmsg("Error", errorThrown); $.unblockUI(); }
                                });
                            }
                            else {
                                swal("Peringatan", data.Pesan, "warning")
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) { showmsg("Error", errorThrown); $.unblockUI(); }
                    });
                });
        }
        else { console.log('Data input wajib belum Anda masukkan'); }

        e.preventDefault();
        return false;
    });

    $("#btntolak").on("click", function (e) {
        var dokid = $('#DraftCode').val();
        if (dokid !== null && dokid !== '') {
            var title = "Konfirmasi Batalkan Pengajuan Konsep";
            if ($('#isTU').val() == "True") {
                title = "Konfirmasi Tolak Pengajuan Konsep"
            }
            swal({
                title: title,
                text: "No. Konsep : " + dokid + "\nHarap masukkan alasan",
                type: "input",
                showCancelButton: true,
                closeOnConfirm: false,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "Ya",
                cancelButtonText: "Batal",
                inputPlaceholder: "Alasan",
                showLoaderOnConfirm: true
            },
                function (inputValue) {
                    if (inputValue === false) return false;
                    $.blockUI({ message: '<div style=\"padding:10px\"><b>Sedang proses... </b><p>harap tunggu</p></div>' });
                    var frm = {
                        id: dokid,
                        alasan: inputValue
                    };
                    $.ajax({
                        url: '@Url.Action("HapusDraft", "TandaTanganElektronik")',
                        type: "POST",
                        data: frm,
                        success: function (data, textStatus, jqXHR) {
                            if (data && data.Status) {
                                swal({
                                    title: "Informasi",
                                    text: data.Pesan,
                                    type: "success",
                                    timer: 1000,
                                    showConfirmButton: false
                                }, function () {
                                    window.location.href = '@Url.Action("ListDraft", "Surat")';
                                });
                            }
                            else {
                                swal("Peringatan", data.Pesan, "warning")
                            }
                            $.unblockUI();
                        },
                        error: function (jqXHR, textStatus, errorThrown) { showmsg("Error", errorThrown); $.unblockUI(); }
                    });
                });
        } else {
            swal("Peringatan", 'Dokumen tidak ditemukan', "warning");
        }
    });

    $("#btnUploadFile").on("change", function (e) {
        var input = $(this),
            numFiles = input.get(0).files ? input.get(0).files.length : 1;
        if (numFiles > 0) {
            var file = dfFileDokumen = input.get(0).files[0];

            if (file.size > 20000 * 1024) {
                dfFileDokumen = null;
                showmsg('Peringatan', 'File maksimum 20Mb');
                $("#namafile").val("");
                $('#fileDokumen').html("");
                return false;
            }
            else {
                $("#validFile").html("");

                if (dfFileDokumen == null) {
                    return false;
                }
                var namafile = dfFileDokumen.name;
                $("#namafile").val(namafile);
                var filedokumen = dfFileDokumen;
                var tipefile = filedokumen.type;

                if (tipefile == 'application/pdf') {
                    var blob = new Blob([dfFileDokumen], { type: "application/pdf;base64" }),
                        objurl = window.URL.createObjectURL(blob);
                    objpdf = objurl;

                    if ($("#fileDokumen").height() < 500) $("#fileDokumen").height(500);
                    PDFObject.embed(objpdf, $("#fileDokumen"), { forcePDFJS: true, PDFJS_URL: '@Url.Content("~/Contents/pdfviewer.html")' });
                }
            }
        }
    });

    var dtableDaftarPegawai;
    var createPagingPenandatangan = function () {
        dtableDaftarPegawai = $('#myTableDaftarPegawai').DataTable({
            "bLengthChange": false,
            "paging": true,
            "pageLength": 10,
            "bFilter": false,
            "ordering": false,
            "info": false,
            "processing": true,
            "serverSide": true,
            "ajax": {
                url: '@Url.Action("GetPegawaiByJabatanNama", "Surat")',
                type: "POST",
                data: function (data) { var ftp = $('#frmDaftarPegawai').serializeArray(); data.form = ftp; ftp.push({ name: "draw", value: data.draw }, { name: "start", value: data.start }, { name: "length", value: data.length }, { name: "metadata", value: $('#UserTTE').val() }, { name: "namajabatan", value: $('#txtJabatan').val() }, { name: "namapegawai", value: $('#txtNama').val() }, { name: "tipe", value: tte }); return ftp; }
            },
            "columns": [
                { "data": "RNumber", "className": "centertaligncolumn", "width": "5%" },
                { "data": "PegawaiId" },
                { "data": "Nama" },
                { "data": "Jabatan" },
                {
                    "data": "Pilih",
                    "className": "centertaligncolumn",
                    "width": "10%",
                    render: function () {
                        return '<i class="fa fa-check" style="cursor: pointer; color:#b72a2a;"></i>';
                    }
                }
            ]
        });
    };

    $('#myTableDaftarPegawai tbody').delegate('tr i', 'click', function (e) {
        e.preventDefault();
        var data = dtableDaftarPegawai.row($(this).closest('tr')).data();
        var metadata = data.PegawaiId;
        if ($('#datatte').html().indexOf("Penandatangan Kosong") != -1) {
            $('#datatte').html("");
        }
        var tipe = "Paraf";
        if (tte == "1") {
            $('#BtnTambahParaf').hide();
            $('#BtnTambahTandaTangan').hide();
            $('#btnsetujudankirim').prop('disabled', false);
            $('#btnsimpandankirim').prop('disabled', false);
            tipe = "Tanda Tangan";
        }
        $('#datatte').append("<tr><td style='width: 152px'><label style='display:none;'>" + data.PegawaiId + "," + tte + "," + data.ProfileId + "</label>" + data.PegawaiId + "</td><td style='width: 123px'>" + data.Nama + "</td><td>" + data.Jabatan + "</td><td style='width: 100px'>" + tipe + "</td><td style='width: 40px;cursor: pointer;' onclick='hapusPenandatangan(this)'><i class='fa fa-trash'></i></td></tr>");
        metadata += "," + tte;
        $('#UserTTE').val($('#UserTTE').val() + "|" + metadata);
        $('#ListPegawaiModal').modal('hide');
    });

    function hapusPenandatangan(e) {
        $(e).closest("tr").remove();
        recheckPenandatangan();
    }

    function recheckPenandatangan() {
        var $tbltte = $("#datatte label");
        var $datas = "";
        $('#ErrPenandatangan').hide();
        $('#BtnTambahParaf').show();
        $('#BtnTambahTandaTangan').show();
        $('#btnsetujudankirim').prop('disabled', true);
        $('#btnsimpandankirim').prop('disabled', true);
        $.each($tbltte, function (i, item) {
            if ($datas != "") $datas += "|"
            $datas += $(this).html();
            if ($(this).html().indexOf(",1,") != -1) {
                $('#BtnTambahParaf').hide();
                $('#BtnTambahTandaTangan').hide();
                $('#btnsetujudankirim').prop('disabled', false);
                $('#btnsimpandankirim').prop('disabled', false);
            }
        });
        $('#UserTTE').val($datas);
    }

    $(document).ready(function () {
        $('#tujuansurat').hide();
        $('#ErrIsiSurat').hide();
        $.validator.methods.number = function (value, element) {
            return this.optional(element) || /^-?(?:\d+|\d{1,3}(?:\.\d{3})+)?(?:,\d+)?$/.test(value);
        }

        $('.select2_single').select2({ width: 'resolve' });

        $('#tanggalsurat').datetimepicker({
            format: 'DD/MM/YYYY',
            locale: 'id'
        });

        $('#ListPegawaiModal').on('shown.bs.modal', function () {
            $(this).find('.modal-dialog').css({
                width: '98%',
                height: '98 %',
                'max-height': '98%'
            });
        });

        $('#DesainKopModal').on('shown.bs.modal', function () {
            $(this).find('.modal-dialog').css({
                width: '98%',
                height: '98 %',
                'max-height': '98%'
            });
        });

        createPagingPenandatangan();

        $(window).scroll(function () {
            if ($(this).scrollTop() > 50) {
                $('#back-to-top').fadeIn();
            } else {
                $('#back-to-top').fadeOut();
            }
        });
        // scroll body to 0px on click
        $('#back-to-top').click(function () {
            $('#back-to-top').tooltip('hide');
            $('body,html').animate({
                scrollTop: 0
            }, 800);
            return false;
        });
        $('#btnsetujudankirim').prop('disabled', true);
        $('#btnsimpandankirim').prop('disabled', true);
        $('#back-to-top').tooltip('show');

        @*$.blockUI({ message: '<div style=\"padding:10px\"><b>Sedang proses... </b><p>harap tunggu</p></div>' });
        $.ajax({
            url: '@Url.Action("GetListTipeSurat", "TandaTanganElektronik")',
            type: "GET",
            dataType: "JSON",
            success: function (ts) {
                $('#tipesurat').html("");
                $('#tipesurat').append($('<option disabled></option>').val("").html("Pilih Tipe Surat"));
                var induk = "";
                $.each(ts, function (i, ts) {
                    if (induk != ts.Induk) {
                        $('#tipesurat').append(
                            $('<option disabled></option>').val("").html(":: " + ts.Induk));
                        induk = ts.Induk
                    }
                    $('#tipesurat').append(
                        $('<option></option>').val(ts.Nama).html(ts.Nama));
                });
                $('#tipesurat').val("");
                $.unblockUI();
            }
        });*@

        $.blockUI({ message: '<div style=\"padding:10px\"><b>Sedang proses... </b><p>harap tunggu</p></div>' });
        $.ajax({
            url: '@Url.Action("GetListSifatSurat", "Surat")',
            type: "GET",
            dataType: "JSON",
            success: function (ss) {
                $('#sifatsurat').html("");
                $('#sifatsurat').append($('<option disabled></option>').val("").html("Pilih Sifat Surat"));
                $.each(ss, function (i, ss) {
                    $('#sifatsurat').append(
                        $('<option></option>').val(ss.Nama).html(ss.Nama));
                });
                $.unblockUI();
            }
        });
        tujuansuratberubah();
        tembusansuratberubah();
        var dokid = $('#DraftCode').val();
        if (dokid != "") {
            $('#ProfilePengirim').val('@Model.ProfilePengirim').change();
            $('#kopsurat').val('@Model.KopSurat').change();
            if ($('#LampiranId').val() != "") {
                $('#divUpload').hide();
                var objurl = '@Url.Action("getLampiran", "Surat")?id=' + dokid;
                objpdf = objurl;

                if ($("#fileDokumen").height() < 500) $("#fileDokumen").height(500);
                PDFObject.embed(objpdf, $("#fileDokumen"), { forcePDFJS: true, PDFJS_URL: '@Url.Content("~/Contents/pdfviewer.html")' });
            }
            $('#editor').html('@Html.Raw(Model.IsiSurat)');

            // Tujuan
            @{
                string tujuan = string.Empty;
                foreach(var tj in Model.Tujuan)
                {
                    tujuan += string.IsNullOrEmpty(tujuan) ? "" : "|";
                    tujuan += tj;
                }
            }
            var tujuan = ('@tujuan').split("|");
            if (tujuan.length > 0) {
                $('#datatujuan').html("");
                $.each(tujuan, function (i, rst) {
                    $('#datatujuan').append("<tr><td><span>" + rst + "</span></td><td style='width: 40px;cursor: pointer;' onclick='hapusTujuan(this)'><i class='fa fa-trash'></i></td></tr>");
                });
            }

            // Tembusan
            @{
                string tembusan = string.Empty;
                foreach(var tj in Model.Tembusan)
                {
                    tembusan += string.IsNullOrEmpty(tembusan) ? "" : "|";
                    tembusan += tj;
                }
            }
            var tembusan = ('@tembusan').split("|");
            if (tembusan.length > 0) {
                $('#datatembusan').html("");
                $.each(tembusan, function (i, rst) {
                    $('#datatembusan').append("<tr><td><span>" + rst + "</span></td><td style='width: 40px;cursor: pointer;' onclick='hapusTujuan(this)'><i class='fa fa-trash'></i></td></tr>");
                });
            }

            // Penandatangan
            @{
                string tte = string.Empty;
                if(Model.TTE != null)
                {
                    foreach (var tj in Model.TTE)
                    {
                        tte += string.IsNullOrEmpty(tte) ? "" : "||";
                        tte += string.Concat(tj.PegawaiId, "*|", tj.ProfileId, "*|", tj.Nama, "*|", tj.Jabatan, "*|", tj.Tipe);
                    }
                }
            }
            var tte = ('@tte').split("||");
            if (tte.length > 0) {
                $('#datatte').html("");
                $.each(tte, function (i, rst) {
                    var t = rst.split("*|");
                    var tipe = "Paraf";
                    if (t[4] == "1") {
                        tipe = "Tanda Tangan";
                    }
                    $('#datatte').append("<tr><td style='width: 152px'><label style='display:none;'>" + t[0] + "," + t[4] + "," + t[1] + "</label>" + t[0] + "</td><td style='width: 123px'>" + t[2] + "</td><td>" + t[3] + "</td><td style='width: 100px'>" + tipe + "</td><td style='width: 40px;cursor: pointer;' onclick='hapusPenandatangan(this)'><i class='fa fa-trash'></i></td></tr>");
                });
                recheckPenandatangan();
            }
            const df = "@Model.DraftCode"
            if (df) {

                var objurl = '@Url.Action("GenerateDokumenElektronik", "Surat")?id=' + String(df);

                objpdf = objurl;

                if ($("#tampilanDokumen").height() < 500) $("#tampilanDokumen").height(500);
                PDFObject.embed(objpdf, $("#tampilanDokumen"), { forcePDFJS: true, PDFJS_URL: '@Url.Content("~/Contents/pdfviewer.html")' });
            }
        }
        else {
            $('#tabStep2').hide();
            $('#tabStep3').hide();
            if ($('#isTU').val() != "True") {
                $('#tabStep4').hide();
            }
            $('#tabStep5').hide();
        }

        $.ajax({
            url: '@Url.Action("GetTujuanSurat", "Surat")',
            type: "GET",
            dataType: "JSON",
            data: { jn: "lain" },
            success: function (data) {
                $('#tujuanEX').autocomplete({
                    lookup: data,
                    lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                        var re = new RegExp('\\b' + $.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                        return re.test(suggestion.value);
                    }
                });
                $('#tembusanEX').autocomplete({
                    lookup: data,
                    lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
                        var re = new RegExp('\\b' + $.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
                        return re.test(suggestion.value);
                    }
                });
            }
        });

        $.ajax({
            url: '@Url.Action("GetTujuanSurat", "Surat")',
            type: "GET",
            dataType: "JSON",
            data: { jn: "bpn" },
            success: function (rst) {
                $("#tujuanIN").html("");
                $('#tujuanIN').append($('<option></option>').val("").html("Pilih Tujuan"));
                $.each(rst, function (i, rst) {
                    $('#tujuanIN').append(
                        $('<option></option>').val(rst.value).html(rst.data));
                });
                $('#tujuanIN').val("");
                $("#tembusanIN").html("");
                $('#tembusanIN').append($('<option></option>').val("").html("Pilih Tembusan"));
                $.each(rst, function (i, rst) {
                    $('#tembusanIN').append(
                        $('<option></option>').val(rst.value).html(rst.data));
                });
                $('#tembusanIN').val("");
            }
        });
    });

    function tujuansuratberubah() {
        var jenis = $('#jenistujuan').val();

        $('#div_tujuanIN').hide();
        $('#div_tujuanEX').hide();
        if (jenis == "bpn") {
            $('#tujuanIN').val("");
            $('#div_tujuanIN').show();
        } else {
            $('#tujuanEX').val("");
            $('#div_tujuanEX').show();
        }
    };

    function hapusTujuan(e) {
        $(e).closest("tr").remove();
        recheckTujuan();
    }

    function recheckTujuan() {
        var $tblTujuan = $("#datatujuan span");
        var $datas = "";
        $.each($tblTujuan, function (i, item) {
            if ($datas != "") $datas += "|";
            $datas += $(this).html();
        });
        $('#ListTujuanSurat').val($datas);
        $('#tujuansurat').hide();
        if ($datas == "") {
            $('#datatujuan').html("<tr><td colspan='2' style='text-align: center;'>Tujuan Kosong</td></tr>");
        }
    }

    function tambahtujuan(t, v) {
        if (t == "in") {
            if ($('#tujuanIN').val() != "") {
                var val = "";
                if (v == "text") {
                    val = $('#tujuanIN option:selected').text();
                } else if (v == "value") {
                    val = $('#tujuanIN').val();
                }
                if (v != "") {
                    if ($('#datatujuan').html().indexOf("Tujuan Kosong") != -1) {
                        $('#datatujuan').html("");
                    }
                    $('#datatujuan').append("<tr><td><span>" + val + "</span></td><td style='width: 40px;cursor: pointer;' onclick='hapusTujuan(this)'><i class='fa fa-trash'></i></td></tr>");
                }
            }
        } else if (t == "ex") {
            var val = $('#tujuanEX').val();
            if (val != "") {
                if ($('#datatujuan').html().indexOf("Tujuan Kosong") != -1) {
                    $('#datatujuan').html("");
                }
                $('#datatujuan').append("<tr><td><span>" + val + "</span></td><td style='width: 40px;cursor: pointer;' onclick='hapusTujuan(this)'><i class='fa fa-trash'></i></td></tr>");
            }
        }
        recheckTujuan();
    }

    function tembusansuratberubah() {
        var jenis = $('#jenistembusan').val();

        $('#div_tembusanIN').hide();
        $('#div_tembusanEX').hide();
        if (jenis == "bpn") {
            $('#tembusanIN').val("");
            $('#div_tembusanIN').show();
        } else {
            $('#tembusanEX').val("");
            $('#div_tembusanEX').show();
        }
    };

    function hapusTembusan(e) {
        $(e).closest("tr").remove();
        recheckTembusan();
    }

    function recheckTembusan() {
        var $tblTembusan = $("#datatembusan span");
        var $datas = "";
        $.each($tblTembusan, function (i, item) {
            if ($datas != "") $datas += "|";
            $datas += $(this).html();
        });
        $('#ListTembusanSurat').val($datas);
        if ($datas == "") {
            $('#datatembusan').html("<tr><td colspan='2' style='text-align: center;'>Tembusan Kosong</td></tr>");
        }
    }

    function tambahtembusan(t, v) {
        if (t == "in") {
            if ($('#tembusanIN').val() != "") {
                var val = "";
                if (v == "text") {
                    val = $('#tembusanIN option:selected').text();
                } else if (v == "value") {
                    val = $('#tembusanIN').val();
                }
                if (v != "") {
                    if ($('#datatembusan').html().indexOf("Tembusan Kosong") != -1) {
                        $('#datatembusan').html("");
                    }
                    $('#datatembusan').append("<tr><td><span>" + val + "</span></td><td style='width: 40px;cursor: pointer;' onclick='hapusTembusan(this)'><i class='fa fa-trash'></i></td></tr>");
                }
            }
        } else if (t == "ex") {
            var val = $('#tembusanEX').val();
            if (val != "") {
                if ($('#datatembusan').html().indexOf("Tembusan Kosong") != -1) {
                    $('#datatembusan').html("");
                }
                $('#datatembusan').append("<tr><td><span>" + val + "</span></td><td style='width: 40px;cursor: pointer;' onclick='hapusTembusan(this)'><i class='fa fa-trash'></i></td></tr>");
            }
        }
    }

    function goStep(f, t) {
        if ($("#frmStep" + f).valid()) {
            recheckTujuan();
            recheckTembusan();
            recheckPenandatangan();
            if (f == 1 && $('#ListTujuanSurat').val() == "") {
                $('#tujuansurat').show();
            }
            else if (f == 2 && $('#editor').html().trim() == "") {
                $('#ErrIsiSurat').show();
            }
            else if (f == 4 && $('#UserTTE').val() == "") {
                $('#ErrPenandatangan').show();
            }
            else {
                $('#ErrIsiSurat').hide();
                $('#tabStep' + t).show();
                $('.nav-tabs li:eq(' + (t - 1) + ') a').tab('show');
            }
        }
    }

    function DoTampilkanDokumen() {
        $.blockUI({ message: '<div style=\"padding:10px\"><b>Sedang proses... </b><p>harap tunggu</p></div>' });
        var frmdata = new FormData();
        var canSave = true;

        if ($("#frmStep1").valid()) {
            recheckTujuan();
            recheckTembusan();
            if ($('#ListTujuanSurat').val() == "") {
                canSave = false;
                $('#tujuansurat').show();
                showalert("Tujuan Surat Harus Dipilih");
                $.unblockUI();
                return false;
            }
            frmdata.append("DraftCode", $('#DraftCode').val());
            frmdata.append("TipeSurat", $('#tipesurat').val());
            frmdata.append("SifatSurat", $('#sifatsurat').val());
            frmdata.append("KodeArsip", $('#kodearsip').val());
            frmdata.append("listTujuan", $('#ListTujuanSurat').val());
            frmdata.append("listTembusan", $('#ListTembusanSurat').val());
            frmdata.append("Perihal", $('#perihal').val());
            frmdata.append("ProfilePengirim", $('#ProfilePengirim').val());
        } else {
            canSave = false;
            showalert("Bagian 'Pengenal' Surat Belum Lengkap");
            $.unblockUI();
            return false;
        }

        if ($("#frmStep2").valid()) {
            if ($('#editor').html().trim() == "") {
                canSave = false;
                $('#ErrIsiSurat').show();
                showalert("Isi Surat Harus Diisi");
                $.unblockUI();
                return false;
            }
            frmdata.append("IsiSurat", encodeURI($('#editor').html().trim()));
        } else {
            canSave = false;
            showalert("Isi Surat Harus Diisi");
            $.unblockUI();
            return false;
        }

        if ($("#frmStep3").valid()) {
            if (dfFileDokumen !== null) {
                var namafile = dfFileDokumen.name;
                var fileExt = '.' + namafile.toLowerCase().split('.').pop();
                if (fileExt !== null && fileExt !== '') {
                    if (fileExt != ".pdf") {
                        $.unblockUI();
                        showalert("File harus pdf");
                        return false;
                    }
                    frmdata.append("NamaFileLampiran", namafile);
                    frmdata.append("EkstensiLampiran", fileExt);
                    frmdata.append("FileLampiran", dfFileDokumen);
                }
                else {
                    swal("Peringatan", "File Lampiran tidak diketemukan", "warning")
                    canSave = false;
                }
            }
            frmdata.append("KopSurat", $('#kopsurat').val());
        } else {
            canSave = false;
        }

        if ($('#isTU').val() == "True") {
            if ($("#frmStep4").valid()) {
                recheckPenandatangan();
                var metadata = $('#UserTTE').val();
                if (metadata == "") {
                    $.unblockUI();
                    $('#ErrPenandatangan').show();
                    showalert("Penandatangan Harus Dipilih");
                    return false;
                }
                frmdata.append("listTTE", metadata);
            } else {
                canSave = false;
            }
        }

        if (canSave) {
            $.unblockUI();
            frmdata.append("PosisiTTE", $('#posisitte').val());
            swal({
                title: "Konfirmasi Simpan Draft",
                text: "Menyimpan dan Menampilkan Konsep Surat",
                type: "info",
                showCancelButton: true,
                closeOnConfirm: false,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "Ya",
                cancelButtonText: "Batal",
                showLoaderOnConfirm: true
            },
                function (isConfirm) {
                    if (isConfirm) {
                        $.ajax({
                            url: '@Url.Action("SimpanDraftNaskahDinas", "Surat")',
                            type: "POST",
                            data: frmdata,
                            contentType: false,
                            processData: false,
                            success: function (data, textStatus, jqXHR) {
                                if (data && data.Status) {
                                    $('#DraftCode').val(data.Pesan);
                                    var objurl = '@Url.Action("GenerateDokumenElektronik", "Surat")?id=' + String(data.Pesan);

                                    objpdf = objurl;

                                    if ($("#tampilanDokumen").height() < 500) $("#tampilanDokumen").height(500);
                                    PDFObject.embed(objpdf, $("#tampilanDokumen"), { forcePDFJS: true, PDFJS_URL: '@Url.Content("~/Contents/pdfviewer.html")' });
                                    swal("Informasi", "Draft berhasil disimpan", "success")
                                }
                                else {
                                    swal("Peringatan", data.Pesan, "warning")
                                }
                            },
                            error: function (jqXHR, textStatus, errorThrown) { showmsg("Error", errorThrown); $.unblockUI(); }
                        });
                    }
                });
        } else {
            swal("Peringatan", "Isian Belum Lengkap", "warning")
            $.unblockUI();
        }
    };
</script>
